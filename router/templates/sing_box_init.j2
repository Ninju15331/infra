#!/bin/sh /etc/rc.common

USE_PROCD=1
START=99

CONFIG_DIR="{{ shared.sing_box.config_dir }}"
TOKEN="{{ router.sing_box_token }}"
WORKER="https://{{ cloudflare.worker_domain }}"

update_configs() {
{% for f in shared.sing_box.files %}
    wget -4 -q -O "${CONFIG_DIR}/{{ f }}.tmp" "${WORKER}/${TOKEN}/{{ f }}" && \
        mv "${CONFIG_DIR}/{{ f }}.tmp" "${CONFIG_DIR}/{{ f }}" || \
        rm -f "${CONFIG_DIR}/{{ f }}.tmp"
{% endfor %}
}

start_service() {
    update_configs

    procd_open_instance "sing-box_service"

    procd_set_param command {{ shared.sing_box.binary }}
    procd_append_param command run -C "$CONFIG_DIR"
    procd_set_param limits core="unlimited"
    procd_set_param limits nofile="1000000 1000000"

    procd_close_instance
}

reload_service() {
    stop
    start
}

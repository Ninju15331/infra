#!/bin/sh /etc/rc.common

USE_PROCD=1
START=99

CONFIG_DIR="{{ shared.sing_box.config_dir }}"
TOKEN="{{ router.sing_box_token }}"
WORKER="https://{{ cloudflare.worker_domain }}"

update_configs() {
{% for f in shared.sing_box.files %}
    wget -4 -q -O "${CONFIG_DIR}/{{ f }}.tmp" "${WORKER}/${TOKEN}/{{ f }}" && \
        mv "${CONFIG_DIR}/{{ f }}.tmp" "${CONFIG_DIR}/{{ f }}" || \
        rm -f "${CONFIG_DIR}/{{ f }}.tmp"
{% endfor %}
}

cleanup_nft() {
    nft delete table ip {{ shared.nftables.table_name_v4 }} 2>/dev/null
    nft delete table ip {{ shared.nftables.divert_table_name_v4 }} 2>/dev/null
    nft delete table ip6 {{ shared.nftables.table_name_v6 }} 2>/dev/null
    nft delete table ip6 {{ shared.nftables.divert_table_name_v6 }} 2>/dev/null
}

start_service() {
    cleanup_nft

    update_configs

    nft -f /etc/nftables/sing-box.nft

    procd_open_instance "sing-box_service"
    procd_set_param command {{ shared.sing_box.binary }}
    procd_append_param command run -C "$CONFIG_DIR"
    procd_set_param limits core="unlimited"
    procd_set_param limits nofile="1000000 1000000"
    procd_close_instance
}

stop_service() {
    cleanup_nft
}

reload_service() {
    update_configs

    if {{ shared.sing_box.binary }} check -C "$CONFIG_DIR" 2>/dev/null; then
        kill -HUP $(pgrep -f "sing-box.*run")
    else
        logger -t sing-box "bad config, skipping reload"
    fi
}
